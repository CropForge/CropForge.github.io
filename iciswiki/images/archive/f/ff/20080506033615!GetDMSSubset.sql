DELIMITER $$;

DROP PROCEDURE IF EXISTS `grc_local_dms`.`getDMSSubset`$$

CREATE DEFINER=`root`@`localhost` PROCEDURE `getDMSSubset`(IN subsetDB varchar(50), IN localDB varchar(50) , IN subSTable varchar(50))
BEGIN
SET @getSubTable = concat('
insert into ',subsetDB,'.data_c ( ounitid, variatid, dvalue )
SELECT locDC.OUNITID, locDC.VARIATID, locDC.DVALUE
FROM ',localDB,'.VARIATE locVar 
INNER JOIN ',localDB,'.data_n locDC ON locVar.VARIATID = locDC.VARIATID
INNER JOIN ',localDB,'.',subSTable,' subS ON subS.studyid = locVar.studyid
');
 PREPARE stmnt1 FROM @getSubTable;
 EXECUTE stmnt1;
 DEALLOCATE PREPARE stmnt1;
SET @getSubTable = concat('
insert into ',subsetDB,'.data_n ( ounitid, variatid, dvalue )
SELECT locDN.OUNITID, locDN.VARIATID, locDN.DVALUE
FROM ',localDB,'.VARIATE locVar 
INNER JOIN ',localDB,'.data_n locDN ON locVar.VARIATID = locDN.VARIATID
INNER JOIN ',localDB,'.',subSTable,' subS ON subS.studyid = locVar.studyid
');
 PREPARE stmnt1 FROM @getSubTable;
 EXECUTE stmnt1;
 DEALLOCATE PREPARE stmnt1;

SET @getSubTable = concat('
INSERT INTO  ',subsetDB,'.DMSATTR ( DMSATID, DMSATYPE, DMSATAB, DMSATREC, DMSATVAL )
SELECT DMSATTR.DMSATID, DMSATTR.DMSATYPE, DMSATTR.DMSATAB, DMSATTR.DMSATREC, DMSATTR.DMSATVAL
FROM  ',localDB,'.DMSATTR 
INNER JOIN  ',localDB,'.VARIATE ON DMSATTR.DMSATREC = VARIATE.VARIATID 
INNER JOIN  ',localDB,'.',subSTable,' subS ON VARIATE.STUDYID = SUBS.STUDYID
WHERE DMSATTR.DMSATYPE=802 AND DMSATTR.DMSATAB="VARIATE"') ; 
PREPARE stmnt1 FROM @getSubTable;
EXECUTE stmnt1;
DEALLOCATE PREPARE stmnt1;
-- 4. Variate
SET @getSubTable = concat('
INSERT INTO  ',subsetDB,'.VARIATE( VARIATID, VNAME, TRAITID, SCALEID, TMETHID, DTYPE, VTYPE, STUDYID )
SELECT VARIATE.VARIATID, VARIATE.VNAME, VARIATE.TRAITID, VARIATE.SCALEID, VARIATE.TMETHID, VARIATE.DTYPE, VARIATE.VTYPE, VARIATE.STUDYID
FROM  ',localDB,'.VARIATE
INNER JOIN   ',localDB,'.',subSTable,' subS  ON VARIATE.STUDYID = SUBS.STUDYID');
PREPARE stmnt1 FROM @getSubTable;
EXECUTE stmnt1;
DEALLOCATE PREPARE stmnt1;
-- 5. Level_C
SET @getSubTable = concat('
INSERT INTO  ',subsetDB,'.LEVEL_C ( LABELID, FACTORID, LEVELNO, LVALUE )
SELECT LEVEL_C.LABELID, LEVEL_C.FACTORID, LEVEL_C.LEVELNO, LEVEL_C.LVALUE
FROM  ',localDB,'.FACTOR 
INNER JOIN  ',localDB,'.LEVEL_C ON FACTOR.LABELID = LEVEL_C.FACTORID
INNER JOIN   ',localDB,'.',subSTable,' subS  ON FACTOR.STUDYID = SUBS.STUDYID');
PREPARE stmnt1 FROM @getSubTable;
EXECUTE stmnt1;
DEALLOCATE PREPARE stmnt1;
-- 6. Level_N table
SET @getSubTable = concat('
INSERT INTO  ',subsetDB,'.LEVEL_N ( LABELID, FACTORID, LEVELNO, LVALUE )
SELECT LEVEL_N.LABELID, LEVEL_N.FACTORID, LEVEL_N.LEVELNO, LEVEL_N.LVALUE
FROM  ',localDB,'.FACTOR 
INNER JOIN  ',localDB,'.LEVEL_N ON FACTOR.LABELID = LEVEL_N.FACTORID
INNER JOIN   ',localDB,'.',subSTable,' subS ON FACTOR.STUDYID = SUBS.STUDYID');
PREPARE stmnt1 FROM @getSubTable;
EXECUTE stmnt1;
DEALLOCATE PREPARE stmnt1;
-- 7. OINDEX table
SET @getSubTable = concat('
INSERT INTO  ',subsetDB,'.OINDEX( OUNITID, FACTORID, LEVELNO, REPRESNO )
SELECT OINDEX.OUNITID, OINDEX.FACTORID, OINDEX.LEVELNO, OINDEX.REPRESNO
FROM  ',localDB,'.FACTOR 
INNER JOIN  ',localDB,'.OINDEX ON FACTOR.FACTORID = OINDEX.FACTORID
INNER JOIN   ',localDB,'.',subSTable,' subS  ON FACTOR.STUDYID = SUBS.STUDYID');
PREPARE stmnt1 FROM @getSubTable;
EXECUTE stmnt1;
DEALLOCATE PREPARE stmnt1;
-- 8.  Effect
SET @getSubTable = concat('
INSERT INTO  ',subsetDB,'.EFFECT ( REPRESNO, FACTORID, EFFECTID )
SELECT EFFECT.REPRESNO, EFFECT.FACTORID, EFFECT.EFFECTID
FROM  ',localDB,'.EFFECT 
INNER JOIN  ',localDB,'.FACTOR ON EFFECT.FACTORID = FACTOR.LABELID
INNER JOIN   ',localDB,'.',subSTable,' subS ON FACTOR.STUDYID = SUBS.STUDYID');
PREPARE stmnt1 FROM @getSubTable;
EXECUTE stmnt1;
DEALLOCATE PREPARE stmnt1;
-- 9. VEffect
SET @getSubTable = concat('
INSERT INTO  ',subsetDB,'.VEFFECT ( REPRESNO, VARIATID )
SELECT VEFFECT.REPRESNO, VARIATE.VARIATID
FROM  ',localDB,'.VARIATE 
INNER JOIN  ',localDB,'.VEFFECT ON VARIATE.VARIATID = VEFFECT.VARIATID
INNER JOIN   ',localDB,'.',subSTable,' subS  ON VARIATE.STUDYID = SUBS.STUDYID');
PREPARE stmnt1 FROM @getSubTable;
EXECUTE stmnt1;
DEALLOCATE PREPARE stmnt1;
-- 10.  Attribute of the factor
SET @getSubTable = concat('
INSERT INTO  ',subsetDB,'.DMSATTR ( DMSATID, DMSATYPE, DMSATAB, DMSATREC, DMSATVAL )
SELECT DMSATTR.DMSATID, DMSATTR.DMSATYPE, DMSATTR.DMSATAB, DMSATTR.DMSATREC, DMSATTR.DMSATVAL
FROM  ',localDB,'.FACTOR 
INNER JOIN  ',localDB,'.DMSATTR ON FACTOR.LABELID = DMSATTR.DMSATREC
INNER JOIN   ',localDB,'.',subSTable,' subS  ON FACTOR.STUDYID = SUBS.STUDYID');
PREPARE stmnt1 FROM @getSubTable;
EXECUTE stmnt1;
DEALLOCATE PREPARE stmnt1;
-- 11. Factor
SET @getSubTable = concat('
INSERT INTO  ',subsetDB,'.FACTOR ( LABELID, FACTORID, STUDYID, FNAME, TRAITID, SCALEID, TMETHID, LTYPE )
SELECT FACTOR.LABELID, FACTOR.FACTORID, FACTOR.STUDYID, FACTOR.FNAME, FACTOR.TRAITID, FACTOR.SCALEID, FACTOR.TMETHID, FACTOR.LTYPE
FROM  ',localDB,'.FACTOR
INNER JOIN   ',localDB,'.',subSTable,' subS  ON FACTOR.STUDYID = SUBS.STUDYID');
PREPARE stmnt1 FROM @getSubTable;
EXECUTE stmnt1;
DEALLOCATE PREPARE stmnt1;
-- 12. Study
SET @getSubTable = concat('
INSERT  INTO ',subsetDB,'.STUDY ( STUDYID, PMKEY, SNAME, TITLE, OBJECTIV, INVESTID, STYPE, SDATE, EDATE )
SELECT STUDY.STUDYID, STUDY.PMKEY, STUDY.SNAME, STUDY.TITLE, STUDY.OBJECTIV, STUDY.INVESTID, STUDY.STYPE, STUDY.SDATE, STUDY.EDATE
FROM  ',localDB,'.STUDY
INNER JOIN   ',localDB,'.',subSTable,' subS  ON STUDY.STUDYID = SUBS.STUDYID');
PREPARE stmnt1 FROM @getSubTable;
EXECUTE stmnt1;
DEALLOCATE PREPARE stmnt1;


END$$

DELIMITER ;$$